version: '3.9'

services:
  # Frontend (Nginx)
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    container_name: bemreal-web
    ports:
      - "80:80"
    environment:
      VITE_API_URL: ${VITE_API_URL:-http://localhost:8000}
    depends_on:
      - api
    networks:
      - bemreal
    restart: unless-stopped

  # Backend (FastAPI)
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    container_name: bemreal-api
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://user:password@postgres:5432/bemreal}
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
      JWT_ALGORITHM: HS256
      JWT_EXPIRATION_SECONDS: 900
      
      AREA_MIN_M2: 100
      GAP_TOLERANCE_M2: 1.0
      SIGEF_OVERLAP_TOLERANCE_M2: 0
      
      S3_BUCKET: ${S3_BUCKET:-bemreal-docs}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
      
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      ENV: ${ENV:-production}
      
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      PAGSEGURO_TOKEN: ${PAGSEGURO_TOKEN}
      
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
    
    networks:
      - bemreal
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # PostgreSQL (local development only)
  postgres:
    image: postgres:15-alpine
    container_name: bemreal-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-bemreal_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-bemreal}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - bemreal
    restart: unless-stopped
    profiles:
      - local

networks:
  bemreal:
    driver: bridge

volumes:
  postgres_data:
