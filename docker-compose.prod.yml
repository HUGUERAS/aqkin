version: '3.9'

services:
  # Frontend (Nginx)
  web:
    image: ghcr.io/${{ github.repository }}-web:${{ github.ref_name }}
    container_name: bemreal-web
    ports:
      - "80:80"
      - "443:443"
    environment:
      VITE_API_URL: ${VITE_API_URL}
    volumes:
      - ./certs:/etc/nginx/certs:ro
      - ./nginx-default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - api
    networks:
      - bemreal
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Backend (FastAPI)
  api:
    image: ghcr.io/${{ github.repository }}-api:${{ github.ref_name }}
    container_name: bemreal-api
    ports:
      - "8000:8000"
    environment:
      # Database (Supabase PostgreSQL)
      DATABASE_URL: ${DATABASE_URL}
      
      # JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_ALGORITHM: HS256
      JWT_EXPIRATION_SECONDS: 900
      
      # Geospatial
      AREA_MIN_M2: 100
      GAP_TOLERANCE_M2: 1.0
      SIGEF_OVERLAP_TOLERANCE_M2: 0
      
      # S3 (Backblaze B2 or AWS S3)
      S3_BUCKET: ${S3_BUCKET}
      S3_REGION: ${S3_REGION}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
      S3_ENDPOINT_URL: ${S3_ENDPOINT_URL}
      
      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS}
      
      # Environment
      ENV: production
      SQL_ECHO: false
      
      # Payments
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      PAGSEGURO_TOKEN: ${PAGSEGURO_TOKEN}
      
      # Python
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
    
    networks:
      - bemreal
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Production logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  bemreal:
    driver: bridge
